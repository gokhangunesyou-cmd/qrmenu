parameters:
    app.public_menu_url: '%env(PUBLIC_MENU_URL)%'
    env(S3_AUTO_SET_PUBLIC_READ_POLICY): '0'

services:
    _defaults:
        autowire: true
        autoconfigure: true
        bind:
            $publicMenuUrl: '%app.public_menu_url%'

    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    App\Doctrine\Filter\TenantFilter:
        tags: []

    App\Doctrine\Listener\TenantFilterListener:
        tags:
            - { name: kernel.event_listener, event: kernel.request, priority: 8 }

    App\Doctrine\Listener\TimestampListener:
        tags:
            - { name: doctrine.event_listener, event: prePersist }
            - { name: doctrine.event_listener, event: preUpdate }

    App\Doctrine\Listener\SoftDeleteListener:
        tags:
            - { name: doctrine.event_listener, event: preRemove }

    App\EventListener\ExceptionListener:
        tags:
            - { name: kernel.event_listener, event: kernel.exception, priority: -10 }

    # Infrastructure bindings
    App\Infrastructure\Storage\LocalStorage:
        arguments:
            $projectDir: '%kernel.project_dir%'

    App\Infrastructure\Storage\S3Storage:
        arguments:
            $s3Client: '@s3_client'
            $bucket: '%env(S3_BUCKET)%'
            $endpoint: '%env(S3_ENDPOINT)%'
            $publicEndpoint: '%env(string:S3_PUBLIC_ENDPOINT)%'
            $autoCreateBucket: '%env(bool:S3_AUTO_CREATE_BUCKET)%'
            $autoSetPublicReadPolicy: '%env(bool:S3_AUTO_SET_PUBLIC_READ_POLICY)%'

    App\Infrastructure\Storage\ConfiguredStorage:
        arguments:
            $localStorage: '@App\Infrastructure\Storage\LocalStorage'
            $s3Storage: '@App\Infrastructure\Storage\S3Storage'
            $driver: '%env(string:STORAGE_DRIVER)%'

    App\Infrastructure\Storage\StorageInterface:
        alias: App\Infrastructure\Storage\ConfiguredStorage


    # S3 Client
    s3_client:
        class: Aws\S3\S3Client
        arguments:
            -
                version: 'latest'
                region: '%env(S3_REGION)%'
                endpoint: '%env(S3_ENDPOINT)%'
                use_path_style_endpoint: '%env(bool:S3_USE_PATH_STYLE)%'
                credentials:
                    key: '%env(S3_ACCESS_KEY)%'
                    secret: '%env(S3_SECRET_KEY)%'

    # Fixtures (autoload from fixtures/ directory)
    App\Fixtures\:
        resource: '../fixtures/'
        tags: ['doctrine.fixture.orm']
